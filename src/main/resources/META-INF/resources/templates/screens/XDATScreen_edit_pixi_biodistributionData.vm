$page.setTitle("Biodistribution Data")
$page.setLinkColor($ui.alink)
$page.setVlinkColor($ui.vlink)
#set($months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"])
#set($days = [ 1..31 ])
#set($years = [ $!turbineUtils.getYear()..2000])
#if ($data.message)
<font color="red" size="3">$data.message</font>
#end
<p>

<form ID="form1" name="form1" method="post" action="$link.setAction("ModifyPixiItem")">
    <input type="hidden" name="project" value="$!{project}">
    #if($vr)
        <font color="red">Invalid parameters:<BR>$vr.toHTML()</font>
        <HR>
    #end

    <TABLE width="100%">
        <TR>
            <TD>
                <table width="100%">
                    <TR>
                        <TD align="left" valign="middle">
                            <DIV class="edit_title">Biodistribution Details</DIV>
                        </TD>
                    </TR>
                </TABLE>
            </TD>
        </TR>
        <TR>
            <TD>
                <TABLE width="100%">
                    <TR>
                        <TD valign="top">
                            <TABLE>
                                <TR>
                                    <TD colspan='2'>
                                        #parse("/screens/xnat_edit_subjectAssessorData.vm")
                                    </TD>
                                </TR>
                                <tr>
                                    <TD colspan="2">#parse("/screens/EditProjectSpecificFields.vm")</TD>
                                </tr>
                                <TR>
                                    #formLabel("Experiment Date/Time")
                                    <TD>
                                        <input type="date"
                                               id="pixi:biodistributionData/date"
                                               name="pixi:biodistributionData/date"
                                               value="$item.getProperty("pixi:biodistributionData/date")">
                                        <input type="time"
                                               id="pixi:biodistributionData/time"
                                               step="1"
                                               name="pixi:biodistributionData/time"
                                               value="$item.getProperty("pixi:biodistributionData/time")">
                                    </TD>
                                </TR>
                                <TR>
                                    #formLabel("Technician")
                                    <TD>#xdatStringBox("pixi:biodistributionData/technician" $item "" $vr)</TD>
                                </TR>
                                <TR>
                                    #formLabel("Animal Weight (g)")
                                    <TD>#xdatTextBox("pixi:biodistributionData/animal_weight" $item "" $vr)</TD>
                                    <TD>#xdatHiddenBox("pixi:biodistributionData/animal_weight_unit" $item "g")</TD>
                                </TR>
                                <TR>
                                    #formLabel("Animal Sacrifice Date/Time")
                                    <TD>
                                        <input type="date"
                                               id="pixi:biodistributionData/animal_sacrifice_date"
                                               name="pixi:biodistributionData/animal_sacrifice_date"
                                               value="$item.getProperty("pixi:biodistributionData/animal_sacrifice_date")">
                                        <input type="time"
                                               id="pixi:biodistributionData/animal_sacrifice_time"
                                               step="1"
                                               name="pixi:biodistributionData/animal_sacrifice_time"
                                               value="$item.getProperty("pixi:biodistributionData/animal_sacrifice_time")">
                                    </TD>
                                </TR>
                            </TABLE>
                        </TD>
                    </TR>
                </TABLE>
            </TD>
        </TR>
        <TR>
            <TD>
                <TABLE>
                    <TR>
                        <TD align="left" valign="top">
                            <TABLE>
                                <TR>
                                    <TH align="left"><BR><font face="$ui.sansSerifFonts" size="2">Injection Data</font></TH>
                                </TR>
                                <TR>
                                    <TD align="left" valign="top">
                                        <TABLE>
                                            <TR>
                                                #formLabel("Tracer")
                                                <TD>#xdatStringBox("pixi:biodistributionData/injection_data/tracer" $item "" $vr)</TD>
                                            </TR>
                                            <TR>
                                                #formLabel("Isotope")
                                                <TD>#xdatStringBox("pixi:biodistributionData/injection_data/isotope" $item "" $vr)</TD>
                                            </TR>
                                            <TR>
                                                #formLabel("Diluent")
                                                <TD>#xdatStringBox("pixi:biodistributionData/injection_data/diluent" $item "" $vr)</TD>
                                            </TR>
                                            <TR>
                                                #formLabel("Injected Dose (&#181;Ci)")
                                                <TD>#xdatTextBox("pixi:biodistributionData/injection_data/injected_dose" $item "" $vr)</TD>
                                                <TD>#xdatHiddenBox("pixi:biodistributionData/injection_data/injected_dose_unit" $item "&#181;Ci")</TD>
                                            </TR>
                                            <TR>
                                                #formLabel("Injection Volume (&#181;L)")
                                                <TD>#xdatTextBox("pixi:biodistributionData/injection_data/injection_volume" $item "" $vr)</TD>
                                                <TD>#xdatHiddenBox("pixi:biodistributionData/injection_data/injection_volume_unit" $item "&#181;L")</TD>
                                            </TR>
                                            <TR>
                                                #formLabel("Total Counts Injected")
                                                <TD>#xdatTextBox("pixi:biodistributionData/injection_data/injection_total_counts" $item "" $vr)</TD>
                                            </TR>
                                            <TR>
                                                #formLabel("Injection Site")
                                                <TD>#xdatStringBox("pixi:biodistributionData/injection_data/injection_site" $item "" $vr)</TD>
                                            </TR>
                                            <TR>
                                                #formLabel("Injection Route")
                                                <TD>#xdatStringBox("pixi:biodistributionData/injection_data/injection_route" $item "" $vr)</TD>
                                            </TR>
                                            <TR>
                                                #formLabel("Injection Date/Time")
                                                <TD>
                                                    <input type="date"
                                                           id="pixi:biodistributionData/injection_data/injection_date"
                                                           name="pixi:biodistributionData/injection_data/injection_date"
                                                           value="$item.getProperty("pixi:biodistributionData/injection_data/injection_date")">
                                                    <input type="time"
                                                           id="pixi:biodistributionData/injection_data/injection_time"
                                                           step="1"
                                                           name="pixi:biodistributionData/injection_data/injection_time"
                                                           value="$item.getProperty("pixi:biodistributionData/injection_data/injection_time")">
                                                </TD>
                                            </TR>
                                            #xdatHiddenBox("pixi:biodistributionData/injection_data/pixi_biodInjectionData_id" $item "")
                                        </TABLE>
                                    </TD>
                                </TR>
                            </TABLE>
                            <!-- END pixi:biodistributionData/injection_data -->
                        </TD>
                    </TR>
                    <TR>
                        <TD align="left" valign="top">
                            <!-- BEGIN pixi:biodistributionData/anesthesia_administration -->
                            <TABLE>
                                <TR><TH align="left"><BR><font face="$ui.sansSerifFonts" size="2">Anesthesia Administration</font></TH></TR>
                                <TR>
                                    <TD align="left" valign="top">
                                        <TABLE>
                                            <TR>
                                                #formLabel("Anesthesia")
                                                <TD>#xdatStringBox("pixi:biodistributionData/anesthesia_administration/anesthesia" $item "" $vr)</TD>
                                            </TR>
                                            <TR>
                                                #formLabel("Administration Route")
                                                <TD>#xdatStringBox("pixi:biodistributionData/anesthesia_administration/routeOfAdministration" $item "" $vr)</TD>
                                            </TR>
                                            #xdatHiddenBox("pixi:biodistributionData/anesthesia_administration/pixi_anesthesiaData_id" $item "")
                                        </TABLE>
                                    </TD>
                                </TR>
                            </TABLE>
                            <!-- END pixi:biodistributionData/anesthesia_administration -->
                        </TD>
                    </TR>
                    <!-- BEGIN pixi:biodistributionData/sample_uptake_data -->
                    <TR><TH align="left"><BR><font face="$ui.sansSerifFonts" size="2">Sample Uptake Data</font></TH></TR>
                    <TR>
                        <TD align="left" valign="top">
                            <TABLE id="sampleUptakeTable">
                                <TR>
                                    <TD>Sample Type</TD>
                                    <TD>Sample Weight (g)</TD>
                                    <TD>Decay Corrected CPM</TD>
                                    <TD>%ID/g</TD>
                                    <TD>%ID/organ</TD>
                                    <TD>Measurement Date</TD>
                                    <TD>Time</TD>
                                    <TD>Timepoint</TD>
                                    <TD></TD>
                                    <TD>Action</TD>
                                </TR>
                                <!-- Template row for cloning -->
                                <TR id="sampleRowTemplate" style="display:none;">
                                    <TD>
                                        <input type="text" id="pixi:biodistributionData/sample_uptake_data[*]/sample_type" name="pixi:biodistributionData/sample_uptake_data[*]/sample_type" value="">
                                    </TD>
                                    <TD>
                                        <input type="text" id="pixi:biodistributionData/sample_uptake_data[*]/sample_weight" name="pixi:biodistributionData/sample_uptake_data[*]/sample_weight" value="">
                                        <input type="hidden" id="pixi:biodistributionData/sample_uptake_data[*]/sample_weight_unit" name="pixi:biodistributionData/sample_uptake_data[*]/sample_weight_unit" value="">
                                    </TD>
                                    <TD>
                                        <input type="text" id="pixi:biodistributionData/sample_uptake_data[*]/decay_corrected_cpm" name="pixi:biodistributionData/sample_uptake_data[*]/decay_corrected_cpm">
                                    </TD>
                                    <TD>
                                        <input type="text" id="pixi:biodistributionData/sample_uptake_data[*]/percent_injected_dose_per_gram" name="pixi:biodistributionData/sample_uptake_data[*]/percent_injected_dose_per_gram">
                                    </TD>
                                    <TD>
                                        <input type="text" id="pixi:biodistributionData/sample_uptake_data[*]/percent_injected_dose_per_organ" name="pixi:biodistributionData/sample_uptake_data[*]/percent_injected_dose_per_organ">
                                    </TD>
                                    <TD>
                                        <input type="date" id="pixi:biodistributionData/sample_uptake_data[*]/measurement_date" name="pixi:biodistributionData/sample_uptake_data[*]/measurement_date">
                                    </TD>
                                    <TD>

                                        <input type="time" id="pixi:biodistributionData/sample_uptake_data[*]/measurement_time" name="pixi:biodistributionData/sample_uptake_data[*]/measurement_time">
                                    </TD>
                                    <TD>
                                        <input type="text" id="pixi:biodistributionData/sample_uptake_data[*]/timepoint_value" name="pixi:biodistributionData/sample_uptake_data[*]/timepoint_value">
                                    </TD>
                                    <TD>
                                        <select id="pixi:biodistributionData/sample_uptake_data[*]/timepoint_unit" name="pixi:biodistributionData/sample_uptake_data[*]/timepoint_unit">
                                            <option value="seconds">second</option>
                                            <option value="minutes">minute</option>
                                            <option value="hours">hour</option>
                                            <option value="days">day</option>
                                        </select>
                                    </TD>
                                    <TD>
                                        <button type="button" onclick="removeSampleRow(this)"><i class="fa fa-trash" title="Remove"></i></button>
                                    </TD>
                                    <TD>
                                        <input type="hidden" id="pixi:biodistributionData/sample_uptake_data[*]/pixi_biodSampleUptakeData_id" name="pixi:biodistributionData/sample_uptake_data[*]/pixi_biodSampleUptakeData_id">
                                    </TD>
                                </TR>
                                <!-- Existing rows -->
                                #set($pixi_biodSampleUptakeData_5_NUM_ROWS=$item.getChildItems("pixi:biodistributionData/sample_uptake_data").size() - 1)
                                #if($pixi_biodSampleUptakeData_5_NUM_ROWS >= 0)
                                    #foreach($pixi_biodSampleUptakeData_5_COUNTER in [0..$pixi_biodSampleUptakeData_5_NUM_ROWS])
                                        <TR>
                                            <TD>#xdatTextBox("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/sample_type" $item "" $vr)</TD>
                                            <TD>#xdatTextBox("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/sample_weight" $item "" $vr) #xdatHiddenBox("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/sample_weight_unit" $item "g")</TD>
                                            <TD>#xdatTextBox("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/decay_corrected_cpm" $item "" $vr)</TD>
                                            <TD>#xdatTextBox("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/percent_injected_dose_per_gram" $item "" $vr)</TD>
                                            <TD>#xdatTextBox("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/percent_injected_dose_per_organ" $item "" $vr)</TD>
                                            <TD>
                                                <input type="date"
                                                       id="pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/measurement_date"
                                                       name="pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/measurement_date"
                                                       value="$item.getProperty("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/measurement_date")">
                                            </TD>
                                            <TD>
                                                <input type="time"
                                                       id="pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/measurement_time"
                                                       step="1"
                                                       name="pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/measurement_time"
                                                       value="$item.getProperty("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/measurement_time")">
                                            </TD>
                                            <TD>
                                                #xdatTextBox("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/timepoint_value" $item "" $vr)
                                            </TD>
                                            <TD>
                                                <select id="pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/timepoint_unit" name="pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/timepoint_unit">
                                                    <option value="seconds" #if($om.getStringProperty("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/timepoint_unit").equals('seconds')) SELECTED #end>seconds</option>
                                                    <option value="minutes" #if($om.getStringProperty("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/timepoint_unit").equals('minutes')) SELECTED #end>minutes</option>
                                                    <option value="hours" #if($om.getStringProperty("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/timepoint_unit").equals('hours')) SELECTED #end>hours</option>
                                                    <option value="days" #if($om.getStringProperty("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/timepoint_unit").equals('days')) SELECTED #end>days</option>
                                                </select>
                                            </TD>
                                            <TD><button type="button" onclick="removeSampleRow(this)"><i class="fa fa-trash" title="Remove"></i></button></TD>
                                            #xdatHiddenBox("pixi:biodistributionData/sample_uptake_data[$pixi_biodSampleUptakeData_5_COUNTER]/pixi_biodSampleUptakeData_id" $item "")
                                        </TR>
                                    #end
                                #end
                            </TABLE>
                            <!-- Add sample row button -->
                            <button type="button" onclick="addSampleRow()">Add Sample</button>
                        </TD>
                    </TR>
                    <!-- END pixi:biodistributionData/sample_uptake_data -->
                </TABLE>
                <!-- END pixi:biodistributionData -->
            </TD>
        </TR>
        <TR>
            #formLabel("Notes")
        </TR>
        <TR>
            <TD>#xdatTextArea("pixi:biodistributionData/note" $item "" $vr 3 45)</TD>
        </TR>
        <TR>
            <TD>
                #xdatEditProps($item $edit_screen)
        <TR>
            <TD COLSPAN=2 ALIGN=left><input type="button" ONCLICK="validateForm();" name="eventSubmit_doInsert"
                                            value="Submit"/></TD>
        </TR>
        </TD>
        </TR>
    </TABLE>
</form>

<script type="text/javascript">
    function addSampleRow() {
        let table = document.getElementById("sampleUptakeTable");
        let templateRow = document.getElementById("sampleRowTemplate");
        let newRow = templateRow.cloneNode(true);
        newRow.style.display = "";
        newRow.removeAttribute("id");

        let rowCount = table.getElementsByTagName("tr").length - 2; // Subtract 2 to account for the template row
        let inputs = newRow.getElementsByTagName("input");

        for (let i = 0; i < inputs.length; i++) {
            let id = inputs[i].id;
            if (id) {
                inputs[i].id = id.replace("[*]", "[" + rowCount + "]");
            }

            let name = inputs[i].name;
            if (name) {
                inputs[i].name = name.replace("[*]", "[" + rowCount + "]");
            }

            if (name && name.endsWith("sample_weight")) {
                inputs[i].addEventListener('change', function() {
                    let weightUnitInput = newRow.querySelector(`input[name='pixi:biodistributionData/sample_uptake_data[${rowCount}]/sample_weight_unit']`);
                    if (this.value) {
                        weightUnitInput.value = "g";
                    } else {
                        weightUnitInput.value = "";
                    }
                });
            }

        }

        table.appendChild(newRow);
    }

    function removeSampleRow(button) {
        let row = button.parentNode.parentNode;
        row.remove();
    }

    function validateForm() {
        validateSubjectAssessorForm();

        // Delete sampleRowTemplate before submitting
        let sampleRowTemplate = document.getElementById("sampleRowTemplate");
        if (sampleRowTemplate) {
            sampleRowTemplate.remove();
        }
        return false;
    }
</script>
