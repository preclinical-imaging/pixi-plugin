<!-- BEGIN pixi-plugin templates/screens/UploadBiodistribution.vm -->
<div class="upload-container">
    <h2>Small Animal Biodistribution Upload</h2>

    <div class="form-instructions">
        <p>Upload a CSV file containing biodistribution data for small animal imaging studies.</p>

        <p>Download a template CSV file <a href="$content.getURI('biod/BiodistributionTemplate.csv')" download>here</a>.
        Please use the template to find the correct column names for the data in your CSV.</p>

        <p> Currently, biodistribution upload via CSV file is only available to owners of a project.
        Only projects for which you have Owner level access have been listed below.</p>
    </div>

    <form id="upload-form" name="upload-form" method="post">

        <fieldset>
            <legend>Project & Data Selection</legend>

            <div class="filter-container">
                <label for="project" class="filter-label">Select Project</label>

                <label class="filter-icon" for="project-filter"><i class="fa fa-search"></i></label>
                <input type="text" id="project-filter" name="project-filter" placeholder="Filter" onkeyup="" class="filter-input"/>

                <select id="project" name="project" form="upload-form" size="8" required class="filer-select"></select>
            </div>

            <div class="form-component">
                <label class="file-label" for="file">Select file to upload</label>
                <input type="file" id="file" name="file" accept=".csv" required/>
            </div>

            <div class="form-component">
                <label for="data_overlap_handling">Choose how to handle overlapping data:</label>
                <select id="data_overlap_handling" name="data_overlap_handling">
                  <option value="throw_error">Do Not Allow Upload</option>
                  <option value="ignore_matching">Upload And Skip Matching Data</option>
                  <option value="upload_overwrite">Upload and Overwrite Matching Data</option>
                </select>
            </div>
        </fieldset>

        <input class="submit" id="upload-button" type="button" name="eventSubmit_doPerform" value="Begin Upload" onclick="submitForm();"/>

    </form>
</div>

<style>

    .upload-container {
        width: 100%;
    }

    .form-instructions {
        margin-bottom: 2em;
    }

    #upload-form {
        display: flex;
        flex-direction: column;
        row-gap: 1em;
        font-size: 14px;
        box-sizing: border-box;
        width: 600px;
    }

    #upload-form label {
        font-weight: normal;
    }

    #upload-form select,
    #upload-form text,
    #upload-form input[type="file"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

    #upload-form .filter-container {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        align-items: center;
        row-gap: 0.5rem;
        margin-bottom: 2rem;
    }

    #upload-form .filter-label {
        flex: 2 1 auto;
    }

    #upload-form .filter-icon {
        flex: 0 0 auto;
        margin-right: 5px;
    }

    #upload-form .form-component {
        display: flex;
        flex-direction: column;
        row-gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    #upload-button {
        width: 30%;
        margin-top: 10px;
        background-color: #0074b8; /* XNAT blue color */
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background-image: none;  /* Remove default button background */
        align-self: flex-end;
    }

    #upload-button:hover {
        background-color: #005eaa; /* Slightly darker blue on hover */
    }

    .input-desc {
        margin: 0 0 10px 0;
        font-size: 12px;
    }

    #upload-form fieldset {
        margin: 1em 0;
        padding: 1em;
        border: 1px solid #ccc;
        background-color: #fdfdfd;
        border-radius: 4px;
    }

    #upload-form legend {
        font-weight: bold;
    }

    #upload-form .advanced-options-button {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        background-image: none;  /* Remove default button background */
    }

</style>

<script type="text/javascript" src="$content.getURI('scripts/xnat/plugin/pixi/pixi-projects.js')"></script>

<script type="text/javascript">
    // Form Elements
    let formEl             = document.getElementById("upload-form");
    let projectEl          = document.getElementById("project");
    let projectFilerInput  = document.getElementById("project-filter");
    let dataOverlapElement = document.getElementById("data_overlap_handling");
    let mappingEl          = document.getElementById("mapping");
    let fileEl             = document.getElementById("file");

    // Form rendering
    let renderProjectSelectBox = function(selectBox, projects) {
        console.debug('renderProjectSelectBox()')

        // Clear select box
        selectBox.options.length = 0;

        projects.forEach(project => {
            let keys = Object.keys(project)
            const permissions_key = keys.filter((key) => key.startsWith("user_role"));
            if (project[permissions_key] != "Owners") {
                return;
            }
            selectBox.options[selectBox.length] = new Option(project['id'], project['id'])
        })
        if (selectBox.options.length === 0) {
            XNAT.ui.dialog.open({
                title: 'No Projects Available For Upload',
                content: `<div class="info">Biodistribution upload is currently limited to project owners. As you are not an owner of any project you are not able to upload biodistribution data.</div>`,
                buttons: [
                    {
                        label: 'OK',
                        isDefault: true,
                        close: true,
                    }
                ]
            })
        }
    }

    // Load projects and mappings then render select boxes
    XNAT.plugin.pixi.projects.getOnlyOwners()
            .then(resultSet => resultSet['ResultSet']['Result'])
            .then(projects => renderProjectSelectBox(projectEl, projects));

    // Event listeners
    let filterProject = (event) => {
        console.debug('filterProject()')

        let filter = event.target.value.toLowerCase();
        let projects = Array.from(projectEl.options);

        projects.forEach(project => {
            project.hidden = !project.value.toLowerCase().includes(filter);
        });
    }

    let alertUserOfOverwriteDecision = (event) => {
        if (event.target.value === "upload_overwrite") {
            console.log("Overwrite Data");
            XNAT.ui.dialog.open({
                title: 'Data Overlap Method Changed',
                content: `<div class="info">Setting the method of handling data overlap may cause data in the system to be overwritten. Only upload data with this set if you know there is no chance of data loss.</div>`,
                buttons: [
                    {
                        label: 'OK',
                        isDefault: true,
                        close: true,
                    }
                ]
            })
        }
    }

    function getProjectLink(id) {
        return XNAT.url.rootUrl('data/projects/' + id);
    }

    function createExperimentLink(experimentId) {
        return XNAT.url.rootUrl('app/action/DisplayItemAction/search_value/' + experimentId + '/search_element/pixi:biodistributionData/search_field/pixi:biodistributionData.ID')
    }

    function createExperimentDetailsList(allExperiments) {
        let fullDetailsList = ''
        for (const experimentId in allExperiments) {
            let experimentLabel = allExperiments[experimentId];
            let experimentLink = createExperimentLink(experimentId);
            let experimentHtmlElement = `<a href=${experimentLink}>${experimentLabel}</a><br>`;
            fullDetailsList = fullDetailsList.concat(experimentHtmlElement);
        }
        fullDetailsList = fullDetailsList.substring(0, fullDetailsList.length - 4);
        return fullDetailsList;
    }

    function createSuccessPrintoutMessage(projectId, data) {
        let project_link = getProjectLink(projectId);
        let experimentsList = createExperimentDetailsList(data);

        if (!jQuery.isEmptyObject(data)) {
            return `<div class="success">Upload and extraction successful. Data has been successfully added to <a href=${project_link}>${projectId}.</a>
                <details>
                      <summary>The following Biodistribution experiments have been created: </summary>${experimentsList}</details></div>`
        } else {
            return `<div class="success">Upload and extraction successful. However, all input data overlaps with existing data and you have selected the skip matching data option. As such, no new data was uploaded to the system.</div>`
        }
    }

    projectFilerInput.addEventListener('keyup', filterProject);
    dataOverlapElement.addEventListener('change', alertUserOfOverwriteDecision);

    async function submitForm() {
        console.debug('submitForm()')

        function validateForm() {
            let validProject = XNAT.validate(projectEl).required().check();
            let validFile = XNAT.validate(fileEl).is('fileType', 'csv').check()
            return validProject && validFile;
        }

        let isValid = validateForm()

        console.debug(`Uploader form validation: ${isValid}`);

        if (!isValid) {
            return;
        }

        let projectId = projectEl.value;
        let dataOverlapHandling = dataOverlapElement.value;
        let uploadId = new Date().toISOString()
                .replaceAll('-', '_')
                .replaceAll(':', '_')
                .replaceAll('.', '_');

        let file = fileEl.files[0];
        let encodedFileName = encodeURIComponent(file.name);
        encodedFileName = encodedFileName.replaceAll('%20', '_'); // Replace spaces with underscores
        let cachePath = `/user/cache/resources/${uploadId}/files/${encodedFileName}`;
        let encodedCachePath = encodeURIComponent(cachePath);
        let userResourceCacheUrl = XNAT.url.csrfUrl(`/data/${cachePath}`);

        let formDataFileOnly = new FormData()
        formDataFileOnly.append('file', file)

        // Upload the zip file to the users cache
        console.debug(`Uploading ${file.name}`);
        XNAT.ui.dialog.static.wait(`Uploading ${file.name}`,{id: "biod_upload"});

        let response = await fetch(userResourceCacheUrl, {
            method: 'PUT',
            body : formDataFileOnly
        })

        if (response.ok) {
            console.debug('Upload to cache successful');
        } else {
            console.error(`Failed to upload ${file.name}`)
            XNAT.ui.dialog.open({
                title: 'Upload Failed',
                content: `<div class="error">Failed to upload ${file.name}.</div>`,
                buttons: [
                    {
                        label: 'OK',
                        isDefault: true,
                        close: true,
                    }
                ]
            })
            return;
        }

        let biodApiUrl = XNAT.url.csrfUrl('/xapi/pixi/biodistribution');
        let biodApiUrlWithParams = XNAT.url.addQueryString(biodApiUrl, [
            `project=${projectId}`,
            `cachePath=${uploadId}/${encodedFileName}`,
            `dataOverlapHandling=${dataOverlapHandling}`
        ]);

        console.debug(`Calling ${biodApiUrlWithParams}`);
        xmodal.loading.open({ title: 'Uploading Biodistribution Data'});
        XNAT.xhr.post({
            url: biodApiUrlWithParams,
            success: function (data) {
                console.log(data);
                console.debug('Upload successful');
                XNAT.ui.dialog.close("biod_upload");
                xmodal.loading.close();
                XNAT.ui.dialog.open({
                    title: 'Upload Successful',
                    content: createSuccessPrintoutMessage(projectId, data),
                    buttons: [
                        {
                            label: 'OK',
                            isDefault: true,
                            close: true,
                        }
                    ]
                })
            },
            error: function(e) {
                console.error(`Failed to extract ${file.name}`)
                XNAT.ui.dialog.close("biod_upload");
                xmodal.loading.close();

                let errorTextWithBreaks = e.responseText.replaceAll("\n", "<br>");

                XNAT.ui.dialog.open({
                    title: 'Extraction Failed',
                    content: `<div class="error">Failed to extract biodistribution data from ${file.name}. <br>${errorTextWithBreaks}</div>`,
                    buttons: [
                        {
                            label: 'OK',
                            isDefault: true,
                            close: true,
                        }
                    ]
                })
            }
        });
    }
</script>
<!-- END pixi-plugin templates/screens/UploadBiodistribution.vm -->